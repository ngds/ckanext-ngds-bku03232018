{# ___NGDS_HEADER_BEGIN___

National Geothermal Data System - NGDS
https://github.com/ngds

File: <filename>

Copyright (c) 2013, Siemens Corporate Technology and Arizona Geological Survey

Please Refer to the README.txt file in the base directory of the NGDS
project:
https://github.com/ngds/ckanext-ngds/README.txt

___NGDS_HEADER_END___ #}

<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>plugin.py</title>
  <link rel="stylesheet" href="../../../pycco.css">
</head>
<body>
<div id="background"></div>
<div id='container'>
  <div class='section'>
    <div class='docs'><h1>plugin.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">from</span> <span class="nn">ckan.plugins</span> <span class="kn">import</span> <span class="n">implements</span><span class="p">,</span> <span class="n">SingletonPlugin</span><span class="p">,</span> <span class="n">IRoutes</span><span class="p">,</span> <span class="n">IConfigurer</span><span class="p">,</span> <span class="n">toolkit</span><span class="p">,</span> <span class="n">IAuthFunctions</span><span class="p">,</span> <span class="n">IFacets</span><span class="p">,</span> \
    <span class="n">ITemplateHelpers</span><span class="p">,</span> <span class="n">IPackageController</span><span class="p">,</span> <span class="n">IConfigurable</span><span class="p">,</span> <span class="n">IActions</span>

<span class="kn">from</span> <span class="nn">ckan.lib.base</span> <span class="kn">import</span> <span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">ckanext.ngds.ngdsui.misc</span> <span class="kn">import</span> <span class="n">helpers</span>
<span class="kn">from</span> <span class="nn">ckanext.ngds.ngdsui.lib.poly</span> <span class="kn">import</span> <span class="n">get_package_ids_in_poly</span>
<span class="kn">from</span> <span class="nn">ckanext.ngds.ngdsui</span> <span class="kn">import</span> <span class="n">authorize</span>

<span class="kn">import</span> <span class="nn">ckanext.datastore.logic.auth</span> <span class="kn">as</span> <span class="nn">datastore_auth</span>
<span class="kn">import</span> <span class="nn">ckanext.ngds.contentmodel.model.contentmodels</span> <span class="kn">as</span> <span class="nn">contentmodels</span>
<span class="kn">import</span> <span class="nn">ckanext.ngds.contentmodel.logic.action</span> <span class="kn">as</span> <span class="nn">contentmodel_action</span>
<span class="kn">import</span> <span class="nn">ckanext.ngds.logic.action.validate</span> <span class="kn">as</span> <span class="nn">validate_action</span>

<span class="kn">from</span> <span class="nn">pylons</span> <span class="kn">import</span> <span class="n">config</span> <span class="k">as</span> <span class="n">ckan_config</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span> <span class="c"># 2.7</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">sqlalchemy.util</span> <span class="kn">import</span> <span class="n">OrderedDict</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">NgdsuiPlugin</span><span class="p">(</span><span class="n">SingletonPlugin</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>Load ckan's authorization module and update the default role with NGDS specific roles.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">customize_ckan_for_ngds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>helpers.get_contributors_list()</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">def</span> <span class="nf">_trans_role_datasteward</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">(</span><span class="s">&#39;Data Steward&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">def</span> <span class="nf">_trans_role_datasubmitter</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">(</span><span class="s">&#39;Data Submitter&#39;</span><span class="p">)</span>

        <span class="n">module_obj</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s">&#39;ckan.new_authz&#39;</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>Create this new module methods for new roles. 'admin' and 'member' already exists in the default roles.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="nb">setattr</span><span class="p">(</span><span class="n">module_obj</span><span class="p">,</span> <span class="s">&#39;_trans_role_datasteward&#39;</span><span class="p">,</span> <span class="n">_trans_role_datasteward</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">module_obj</span><span class="p">,</span> <span class="s">&#39;_trans_role_datasubmitter&#39;</span><span class="p">,</span> <span class="n">_trans_role_datasubmitter</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">ckan</span> <span class="kn">import</span> <span class="n">new_authz</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>Initialise NGDS roles.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">new_authz</span><span class="o">.</span><span class="n">ROLE_PERMISSIONS</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">([</span>
                <span class="p">(</span><span class="s">&#39;admin&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;admin&#39;</span><span class="p">]),</span>
                <span class="p">(</span><span class="s">&#39;datasteward&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;read&#39;</span><span class="p">,</span> <span class="s">&#39;delete_dataset&#39;</span><span class="p">,</span> <span class="s">&#39;create_dataset&#39;</span><span class="p">,</span> <span class="s">&#39;update_dataset&#39;</span><span class="p">,</span><span class="s">&#39;publish_dataset&#39;</span><span class="p">]),</span>
                <span class="p">(</span><span class="s">&#39;datasubmitter&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;read&#39;</span><span class="p">,</span> <span class="s">&#39;create_dataset&#39;</span><span class="p">,</span><span class="s">&#39;update_dataset&#39;</span><span class="p">]),</span>
                <span class="p">(</span><span class="s">&#39;member&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;read&#39;</span><span class="p">]),</span>
        <span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">create_default_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data_dict</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Group</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;public&#39;</span><span class="p">)</span>

        <span class="k">print</span> <span class="n">group</span>

        <span class="k">if</span> <span class="n">group</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;success &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;fail&quot;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>data_dict['name'] = 'default'
data_dict['type'] = 'organization'
context= {}
data_dict['users'] = [{'name': 'admin', 'capacity': 'admin'}]
get_action('group_create')(context, data_dict)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">contentmodel_configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&quot;usgin_url&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="n">contentmodels</span><span class="o">.</span><span class="n">usgin_url</span><span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&quot;usgin_url&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">contentmodels</span><span class="o">.</span><span class="n">usgin_url</span><span class="o">=</span> <span class="s">&quot;http://schemas.usgin.org/contentmodels.json&quot;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>Access the URL and fill the cache</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">print</span> <span class="s">&quot;Caching Content Models from USGIN: &quot;</span> <span class="o">+</span> <span class="n">contentmodels</span><span class="o">.</span><span class="n">usgin_url</span>
        <span class="n">contentmodel_action</span><span class="o">.</span><span class="n">contentmodel_refreshCache</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="n">True_List</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;true&quot;</span><span class="p">,</span> <span class="s">&quot;1&quot;</span><span class="p">,</span> <span class="s">&quot;t&quot;</span><span class="p">,</span> <span class="s">&quot;y&quot;</span><span class="p">,</span> <span class="s">&quot;yes&quot;</span><span class="p">,</span> <span class="s">&quot;yeah&quot;</span><span class="p">,</span> <span class="s">&quot;yup&quot;</span><span class="p">,</span> <span class="s">&quot;certainly&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s">&quot;checkfile_maxerror&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">checkfile_maxerror</span><span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&quot;checkfile_maxerror&quot;</span><span class="p">]</span>
                <span class="n">contentmodels</span><span class="o">.</span><span class="n">checkfile_maxerror</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">checkfile_maxerror</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;DON&#39;T UNDERSTAND the &#39;checkfile_maxerror&#39; in the development.ini, it is not an Integer&quot;</span>
        <span class="k">print</span> <span class="s">&quot;checkfile_maxerror&quot;</span><span class="p">,</span> <span class="n">contentmodels</span><span class="o">.</span><span class="n">checkfile_maxerror</span>

        <span class="k">if</span> <span class="s">&quot;checkfile_checkheader&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">checkfile_checkheader</span><span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&quot;checkfile_checkheader&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">checkfile_checkheader</span> <span class="ow">in</span> <span class="n">True_List</span><span class="p">:</span>
                    <span class="n">contentmodels</span><span class="o">.</span><span class="n">checkfile_checkheader</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">contentmodels</span><span class="o">.</span><span class="n">checkfile_checkheader</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;DON&#39;T UNDERSTAND the &#39;checkfile_checkheader&#39; in the development.ini, it is not a boolean string&quot;</span>
        <span class="k">print</span> <span class="s">&quot;checkfile_checkheader&quot;</span><span class="p">,</span> <span class="n">contentmodels</span><span class="o">.</span><span class="n">checkfile_checkheader</span>

        <span class="k">if</span> <span class="s">&quot;checkfile_checkoptionalfalse&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">checkfile_checkoptionalfalse</span><span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&quot;checkfile_checkoptionalfalse&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">checkfile_checkoptionalfalse</span> <span class="ow">in</span> <span class="n">True_List</span><span class="p">:</span>
                    <span class="n">contentmodels</span><span class="o">.</span><span class="n">checkfile_checkoptionalfalse</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">contentmodels</span><span class="o">.</span><span class="n">checkfile_checkoptionalfalse</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;DON&#39;T UNDERSTAND the &#39;checkfile_checkoptionalfalse&#39; in the development.ini, it is not a boolean string&quot;</span>
        <span class="k">print</span> <span class="s">&quot;checkfile_checkoptionalfalse&quot;</span><span class="p">,</span> <span class="n">contentmodels</span><span class="o">.</span><span class="n">checkfile_checkoptionalfalse</span>

    <span class="n">implements</span><span class="p">(</span><span class="n">IConfigurable</span><span class="p">,</span> <span class="n">inherit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contentmodel_configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="n">implements</span><span class="p">(</span><span class="n">IRoutes</span><span class="p">,</span><span class="n">inherit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>For the moment, set up routes under the sub-root /ngds to render the UI.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">before_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">map</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">home_controller</span> <span class="o">=</span> <span class="s">&quot;ckanext.ngds.ngdsui.controllers.home:HomeController&quot;</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;home&quot;</span><span class="p">,</span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="n">controller</span><span class="o">=</span><span class="n">home_controller</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&quot;render_index&quot;</span><span class="p">,</span><span class="n">conditions</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;method&quot;</span><span class="p">:[</span><span class="s">&quot;GET&quot;</span><span class="p">]})</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;ngds_home&quot;</span><span class="p">,</span><span class="s">&quot;/ngds&quot;</span><span class="p">,</span><span class="n">controller</span><span class="o">=</span><span class="n">home_controller</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&quot;render_index&quot;</span><span class="p">,</span><span class="n">conditions</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;method&quot;</span><span class="p">:[</span><span class="s">&quot;GET&quot;</span><span class="p">]})</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;initiate_search&quot;</span><span class="p">,</span><span class="s">&quot;/ngds/initiate_search&quot;</span><span class="p">,</span><span class="n">controller</span><span class="o">=</span><span class="n">home_controller</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&quot;initiate_search&quot;</span><span class="p">,</span><span class="n">conditions</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;method&quot;</span><span class="p">:[</span><span class="s">&quot;POST&quot;</span><span class="p">]})</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;about&quot;</span><span class="p">,</span><span class="s">&quot;/ngds/about&quot;</span><span class="p">,</span><span class="n">controller</span><span class="o">=</span><span class="n">home_controller</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&quot;render_about&quot;</span><span class="p">,</span><span class="n">conditions</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;method&quot;</span><span class="p">:[</span><span class="s">&quot;GET&quot;</span><span class="p">]})</span>

        <span class="n">contribute_controller</span> <span class="o">=</span> <span class="s">&quot;ckanext.ngds.ngdsui.controllers.contribute:ContributeController&quot;</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;contribute&quot;</span><span class="p">,</span><span class="s">&quot;/ngds/contribute&quot;</span><span class="p">,</span><span class="n">controller</span><span class="o">=</span><span class="n">contribute_controller</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&quot;index&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;create_or_update_resource&quot;</span><span class="p">,</span><span class="s">&quot;/ngds/contribute/create_or_update_resource&quot;</span><span class="p">,</span><span class="n">controller</span><span class="o">=</span><span class="n">contribute_controller</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&quot;create_or_update_resource&quot;</span><span class="p">,</span><span class="n">conditions</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;method&quot;</span><span class="p">:[</span><span class="s">&quot;POST&quot;</span><span class="p">]})</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="s">&#39;/ngds/contribute/dataset/{action}&#39;</span><span class="p">,</span> <span class="s">&#39;/dataset/{action}&#39;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;bulk_upload&quot;</span><span class="p">,</span><span class="s">&quot;/ngds/bulk_upload&quot;</span><span class="p">,</span><span class="n">controller</span><span class="o">=</span><span class="n">contribute_controller</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&quot;bulk_upload&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;bulk_upload_handle&quot;</span><span class="p">,</span><span class="s">&quot;/ngds/bulk_upload_handle&quot;</span><span class="p">,</span><span class="n">controller</span><span class="o">=</span><span class="n">contribute_controller</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&quot;bulk_upload_handle&quot;</span><span class="p">)</span>

        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;bulk_upload_list&quot;</span><span class="p">,</span><span class="s">&quot;/ngds/bulkupload_list&quot;</span><span class="p">,</span><span class="n">controller</span><span class="o">=</span><span class="n">contribute_controller</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&quot;bulkupload_list&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;bulk_upload_package&quot;</span><span class="p">,</span><span class="s">&quot;/ngds/bulkupload_package&quot;</span><span class="p">,</span><span class="n">controller</span><span class="o">=</span><span class="n">contribute_controller</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&quot;bulkupload_package_list&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;execute_bulkupload&quot;</span><span class="p">,</span><span class="s">&quot;/ngds/execute_bulkupload&quot;</span><span class="p">,</span><span class="n">controller</span><span class="o">=</span><span class="n">contribute_controller</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&quot;execute_bulkupload&quot;</span><span class="p">)</span>

        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;rating_submit&quot;</span><span class="p">,</span><span class="s">&quot;/ngds/rating_submit&quot;</span><span class="p">,</span><span class="n">controller</span><span class="o">=</span><span class="n">home_controller</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&quot;rating_submit&quot;</span><span class="p">,</span><span class="n">conditions</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;method&quot;</span><span class="p">:[</span><span class="s">&quot;POST&quot;</span><span class="p">]})</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;save_search&quot;</span><span class="p">,</span><span class="s">&quot;/ngds/save_search&quot;</span><span class="p">,</span><span class="n">controller</span><span class="o">=</span><span class="n">home_controller</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;save_search&quot;</span><span class="p">,</span><span class="n">conditions</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;method&quot;</span><span class="p">:[</span><span class="s">&quot;POST&quot;</span><span class="p">]})</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>Map related paths</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;map&quot;</span><span class="p">,</span><span class="s">&quot;/ngds/map&quot;</span><span class="p">,</span><span class="n">controller</span><span class="o">=</span><span class="n">home_controller</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&quot;render_map&quot;</span><span class="p">,</span><span class="n">conditions</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;method&quot;</span><span class="p">:[</span><span class="s">&quot;GET&quot;</span><span class="p">]})</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;library&quot;</span><span class="p">,</span><span class="s">&quot;/ngds/library&quot;</span><span class="p">,</span><span class="n">controller</span><span class="o">=</span><span class="n">home_controller</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&quot;render_library&quot;</span><span class="p">,</span><span class="n">conditions</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;method&quot;</span><span class="p">:[</span><span class="s">&quot;GET&quot;</span><span class="p">]})</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;resources&quot;</span><span class="p">,</span><span class="s">&quot;/ngds/resources&quot;</span><span class="p">,</span><span class="n">controller</span><span class="o">=</span><span class="n">home_controller</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&quot;render_resources&quot;</span><span class="p">,</span><span class="n">conditions</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;method&quot;</span><span class="p">:[</span><span class="s">&quot;GET&quot;</span><span class="p">]})</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="s">&quot;search&quot;</span><span class="p">,</span><span class="s">&quot;/ngds/library/search&quot;</span><span class="p">,</span><span class="s">&quot;/dataset&quot;</span><span class="p">,</span> <span class="n">highlight_actions</span><span class="o">=</span><span class="s">&#39;index search&#39;</span><span class="p">)</span>

        <span class="n">user_controller</span> <span class="o">=</span> <span class="s">&quot;ckanext.ngds.ngdsui.controllers.user:UserController&quot;</span>

        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;manage_users&quot;</span><span class="p">,</span> <span class="s">&quot;/ngds/users&quot;</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="n">user_controller</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;manage_users&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;member_new&quot;</span><span class="p">,</span> <span class="s">&quot;/ngds/member_new&quot;</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="n">user_controller</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;member_new&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;logout_page&quot;</span><span class="p">,</span> <span class="s">&quot;/user/logged_out_redirect&quot;</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="n">user_controller</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;logged_out_page&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;validate_resource&quot;</span><span class="p">,</span> <span class="s">&quot;/ngds/contribute/validate_resource&quot;</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="n">contribute_controller</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;validate_resource&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;additional_metadata&quot;</span><span class="p">,</span> <span class="s">&quot;/ngds/contribute/additional_metadata&quot;</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="n">contribute_controller</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;additional_metadata&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;new_metadata&quot;</span><span class="p">,</span> <span class="s">&quot;/ngds/contribute/new_metadata&quot;</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="n">contribute_controller</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;new_metadata&quot;</span><span class="p">)</span>

        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;execute_fulltext_indexer&quot;</span><span class="p">,</span> <span class="s">&quot;/ngds/execute_fulltext_indexer&quot;</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="n">contribute_controller</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;execute_fulltext_indexer&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>Footer URLS</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;partners&quot;</span><span class="p">,</span> <span class="s">&quot;/ngds/partners&quot;</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="n">home_controller</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;render_partners&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">,</span> <span class="s">&quot;/ngds/data&quot;</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="n">home_controller</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;render_data&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;history&quot;</span><span class="p">,</span> <span class="s">&quot;/ngds/history&quot;</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="n">home_controller</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;render_history&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;new_to_ngds&quot;</span><span class="p">,</span> <span class="s">&quot;/ngds/new_to_ngds&quot;</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="n">home_controller</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;render_new_to_ngds&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;faq&quot;</span><span class="p">,</span> <span class="s">&quot;/ngds/faq&quot;</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="n">home_controller</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;render_faq&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;contributors_list&quot;</span><span class="p">,</span> <span class="s">&quot;/ngds/contributors_list&quot;</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="n">home_controller</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;render_contributors&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">map</span>

    <span class="n">implements</span><span class="p">(</span><span class="n">IConfigurer</span><span class="p">,</span> <span class="n">inherit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>Register the templates directory with ckan so that Jinja can find them.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">update_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">toolkit</span><span class="o">.</span><span class="n">add_template_directory</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>Static files are to be served up from here. Otherwise, pylons will try and decode content in here and will fail.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">toolkit</span><span class="o">.</span><span class="n">add_public_directory</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s">&#39;public&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">customize_ckan_for_ngds</span><span class="p">()</span>

    <span class="n">implements</span><span class="p">(</span><span class="n">IActions</span><span class="p">,</span> <span class="n">inherit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
        <span class="s">&#39;contentmodel_refreshCache&#39;</span> <span class="p">:</span> <span class="n">contentmodel_action</span><span class="o">.</span><span class="n">contentmodel_refreshCache</span><span class="p">,</span>
        <span class="s">&#39;contentmodel_list&#39;</span> <span class="p">:</span> <span class="n">contentmodel_action</span><span class="o">.</span><span class="n">contentmodel_list</span><span class="p">,</span>
        <span class="s">&#39;contentmodel_list_short&#39;</span> <span class="p">:</span> <span class="n">contentmodel_action</span><span class="o">.</span><span class="n">contentmodel_list_short</span><span class="p">,</span>
        <span class="s">&#39;contentmodel_get&#39;</span><span class="p">:</span> <span class="n">contentmodel_action</span><span class="o">.</span><span class="n">contentmodel_get</span><span class="p">,</span>
        <span class="s">&#39;contentmodel_checkFile&#39;</span><span class="p">:</span> <span class="n">contentmodel_action</span><span class="o">.</span><span class="n">contentmodel_checkFile</span><span class="p">,</span>
        <span class="s">&#39;contentmodel_checkBulkFile&#39;</span><span class="p">:</span><span class="n">contentmodel_action</span><span class="o">.</span><span class="n">contentmodel_checkBulkFile</span><span class="p">,</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>'create_resource_document_index': lib_action.create_resource_document_index</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="s">&#39;validate_resource&#39;</span><span class="p">:</span> <span class="n">validate_action</span><span class="o">.</span><span class="n">validate_resource</span><span class="p">,</span>
        <span class="s">&#39;validate_dataset_metadata&#39;</span><span class="p">:</span><span class="n">validate_action</span><span class="o">.</span><span class="n">validate_dataset_metadata</span>
        <span class="p">}</span>

    <span class="n">implements</span><span class="p">(</span><span class="n">IAuthFunctions</span><span class="p">,</span> <span class="n">inherit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get_auth_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s">&#39;manage_users&#39;</span><span class="p">:</span> <span class="n">authorize</span><span class="o">.</span><span class="n">manage_users</span><span class="p">,</span>
            <span class="s">&#39;publish_dataset&#39;</span><span class="p">:</span> <span class="n">authorize</span><span class="o">.</span><span class="n">publish_dataset</span><span class="p">,</span>
            <span class="s">&#39;manage_nodes&#39;</span><span class="p">:</span> <span class="n">authorize</span><span class="o">.</span><span class="n">manage_nodes</span><span class="p">,</span>
            <span class="s">&#39;execute_bulkupload&#39;</span><span class="p">:</span><span class="n">authorize</span><span class="o">.</span><span class="n">execute_bulkupload</span><span class="p">,</span>
            <span class="s">&#39;contentmodel_refreshCache&#39;</span> <span class="p">:</span> <span class="n">datastore_auth</span><span class="o">.</span><span class="n">datastore_create</span><span class="p">,</span>
            <span class="s">&#39;contentmodel_list&#39;</span> <span class="p">:</span> <span class="n">datastore_auth</span><span class="o">.</span><span class="n">datastore_create</span><span class="p">,</span>
            <span class="s">&#39;contentmodel_checkFile&#39;</span> <span class="p">:</span> <span class="n">datastore_auth</span><span class="o">.</span><span class="n">datastore_create</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">implements</span><span class="p">(</span><span class="n">ITemplateHelpers</span><span class="p">,</span> <span class="n">inherit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get_helpers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">&#39;get_responsible_party_name&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">get_responsible_party_name</span><span class="p">,</span>
            <span class="s">&#39;get_default_group&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">get_default_group</span><span class="p">,</span>
            <span class="s">&#39;get_login_url&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">get_login_url</span><span class="p">,</span>
            <span class="s">&#39;get_language&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">get_language</span><span class="p">,</span>
            <span class="s">&#39;get_url_for_file&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">get_url_for_file</span><span class="p">,</span>
            <span class="s">&#39;is_plugin_enabled&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">is_plugin_enabled</span><span class="p">,</span>
            <span class="s">&#39;username_for_id&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">username_for_id</span><span class="p">,</span>
            <span class="s">&#39;get_formatted_date&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">get_formatted_date</span><span class="p">,</span>
            <span class="s">&#39;load_ngds_facets&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">load_ngds_facets</span><span class="p">,</span>
            <span class="s">&#39;get_ngdsfacets&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">get_ngdsfacets</span><span class="p">,</span>
            <span class="s">&#39;get_formatted_date&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">get_formatted_date</span><span class="p">,</span>
            <span class="s">&#39;get_formatted_date_from_obj&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">get_formatted_date_from_obj</span><span class="p">,</span>
            <span class="s">&#39;get_field_title&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">get_field_title</span><span class="p">,</span>
            <span class="s">&#39;is_string_field&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">is_string_field</span><span class="p">,</span>
            <span class="s">&#39;is_ogc_publishable&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">is_ogc_publishable</span><span class="p">,</span>
            <span class="s">&#39;jsonify&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">jsonify</span><span class="p">,</span>
            <span class="s">&#39;highlight_rating_star&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">highlight_rating_star</span><span class="p">,</span>
            <span class="s">&#39;count_rating_reviews&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">count_rating_reviews</span><span class="p">,</span>
            <span class="s">&#39;rating_text&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">rating_text</span><span class="p">,</span>
            <span class="s">&#39;get_usersearches&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">get_usersearches</span><span class="p">,</span>
            <span class="s">&#39;get_dataset_category_image_path&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">get_dataset_category_image_path</span><span class="p">,</span>
            <span class="s">&#39;is_following&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">is_following</span><span class="p">,</span>
            <span class="s">&#39;parseJSON&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">parseJSON</span><span class="p">,</span>
            <span class="s">&#39;json_extract&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">json_extract</span><span class="p">,</span>
            <span class="s">&#39;get_master_style&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">get_master_style</span><span class="p">,</span>
            <span class="s">&#39;toJSON&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">to_json</span><span class="p">,</span>
            <span class="s">&#39;split&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">split</span><span class="p">,</span>
            <span class="s">&#39;get_label_for_pkg_attribute&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">get_label_for_pkg_attribute</span><span class="p">,</span>
            <span class="s">&#39;is_json&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">is_json</span><span class="p">,</span>
            <span class="s">&#39;get_label_for_resource_attribute&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">get_label_for_resource_attribute</span><span class="p">,</span>
            <span class="s">&#39;is_development&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">is_development</span><span class="p">,</span>
            <span class="s">&#39;get_rating_details&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">get_rating_details</span><span class="p">,</span>
            <span class="s">&#39;get_top_5_harvest_sources&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">get_top_5_harvest_sources</span><span class="p">,</span>
            <span class="s">&#39;get_home_images&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">get_home_images</span><span class="p">,</span>
            <span class="s">&#39;get_filtered_items&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">get_filtered_items</span><span class="p">,</span>
            <span class="s">&#39;get_content_models&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">get_content_models</span><span class="p">,</span>
            <span class="s">&#39;get_contributors_list&#39;</span><span class="p">:</span><span class="n">helpers</span><span class="o">.</span><span class="n">get_contributors_list</span>
        <span class="p">}</span>

    <span class="n">implements</span><span class="p">(</span><span class="n">IPackageController</span><span class="p">,</span> <span class="n">inherit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">before_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg_dict</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p>pkg_dict['sample_created']={'prahadeesh':'abclll'}</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">is_full_text_enabled</span> <span class="o">=</span> <span class="n">ckan_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ngds.full_text_indexing&#39;</span><span class="p">,</span><span class="s">&#39;false&#39;</span><span class="p">)</span>

        <span class="n">file_formats_to_ignore</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;csv&#39;</span><span class="p">)</span>


        <span class="kn">import</span> <span class="nn">json</span>
        <span class="k">if</span> <span class="n">pkg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;data_dict&#39;</span><span class="p">):</span>
            <span class="nb">dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pkg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;data_dict&#39;</span><span class="p">))</span>
            <span class="n">resources</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;resources&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>print "resources: ", resources</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">resources</span><span class="p">:</span>
            <span class="n">document_index_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">:</span>

                <span class="n">res_file_field</span> <span class="o">=</span> <span class="s">&#39;resource_file_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <p>print "res_file_field:", res_file_field</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">pkg_dict</span><span class="p">[</span><span class="n">res_file_field</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">okey</span><span class="p">,</span> <span class="n">nkey</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[(</span><span class="s">&#39;distributor&#39;</span><span class="p">,</span> <span class="s">&#39;res_distributor&#39;</span><span class="p">),</span>
                                         <span class="p">(</span><span class="s">&#39;protocol&#39;</span><span class="p">,</span> <span class="s">&#39;res_protocol&#39;</span><span class="p">),</span>
                                         <span class="p">(</span><span class="s">&#39;layer&#39;</span><span class="p">,</span> <span class="s">&#39;res_layer&#39;</span><span class="p">),</span>
                                         <span class="p">(</span><span class="s">&#39;resource_format&#39;</span><span class="p">,</span> <span class="s">&#39;res_resource_format&#39;</span><span class="p">),</span>
                                         <span class="p">(</span><span class="s">&#39;content_model&#39;</span><span class="p">,</span> <span class="s">&#39;res_content_model&#39;</span><span class="p">)]:</span>
                        <span class="n">pkg_dict</span><span class="p">[</span><span class="n">nkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">pkg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nkey</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">okey</span><span class="p">,</span> <span class="s">u&#39;&#39;</span><span class="p">)]</span>

                    <span class="k">if</span> <span class="n">is_full_text_enabled</span> <span class="o">==</span> <span class="s">&#39;true&#39;</span> <span class="ow">and</span> <span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;resource_format&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;unstructured&#39;</span> <span class="ow">and</span> \
                            <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;format&#39;</span><span class="p">,</span> <span class="s">u&#39;&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file_formats_to_ignore</span><span class="p">:</span>

                        <span class="n">file_path</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">file_path_from_url</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;url&quot;</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">file_path</span><span class="p">:</span>
                            <span class="n">resource_index_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;package_id&#39;</span><span class="p">:</span> <span class="n">pkg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">),</span>
                                           <span class="s">&#39;resource_id&#39;</span><span class="p">:</span> <span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">),</span>
                                           <span class="s">&#39;file_path&#39;</span><span class="p">:</span> <span class="n">file_path</span><span class="p">,</span>
                                           <span class="p">}</span>
                            <span class="n">document_index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resource_index_dict</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;Exception while getting some full text indexing values: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">ex</span>

            <span class="k">if</span> <span class="n">is_full_text_enabled</span> <span class="o">==</span> <span class="s">&#39;true&#39;</span> <span class="ow">and</span> <span class="n">document_index_list</span><span class="p">:</span>
                <span class="n">helpers</span><span class="o">.</span><span class="n">create_package_resource_document_index</span><span class="p">(</span><span class="n">pkg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">),</span>  <span class="n">document_index_list</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pkg_dict</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">before_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">search_params</span><span class="p">):</span>

        <span class="k">if</span> <span class="s">&#39;fq&#39;</span> <span class="ow">in</span> <span class="n">search_params</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">def</span> <span class="nf">repl</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
                <span class="n">datestr</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
                <span class="n">datestr</span> <span class="o">=</span> <span class="n">datestr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">datestr</span>
            <span class="n">search_params</span><span class="p">[</span><span class="s">&#39;fq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;publication_date:&quot;.*&quot;&#39;</span><span class="p">,</span> <span class="n">repl</span><span class="p">,</span> <span class="n">search_params</span><span class="p">[</span><span class="s">&#39;fq&#39;</span><span class="p">])</span>


        <span class="k">if</span> <span class="s">&#39;extras&#39;</span> <span class="ow">in</span> <span class="n">search_params</span> <span class="ow">and</span> <span class="s">&#39;poly&#39;</span> <span class="ow">in</span> <span class="n">search_params</span><span class="p">[</span><span class="s">&#39;extras&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">search_params</span><span class="p">[</span><span class="s">&#39;extras&#39;</span><span class="p">][</span><span class="s">&#39;poly&#39;</span><span class="p">]:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      <p>do some validation
We'll perform the existing search but also filtering by the ids
of datasets within the bbox</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">x</span> <span class="o">=</span>  <span class="p">{</span> <span class="s">&#39;poly&#39;</span><span class="p">:</span><span class="n">search_params</span><span class="p">[</span><span class="s">&#39;extras&#39;</span><span class="p">][</span><span class="s">&#39;poly&#39;</span><span class="p">]</span> <span class="p">}</span>
            <span class="n">bbox_query_ids</span> <span class="o">=</span> <span class="n">get_package_ids_in_poly</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="s">&#39;4326&#39;</span><span class="p">)</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">search_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;q&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="n">new_q</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> AND &#39;</span> <span class="o">%</span> <span class="n">q</span> <span class="k">if</span> <span class="n">q</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
            <span class="n">new_q</span> <span class="o">+=</span> <span class="s">&#39;(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="s">&#39; OR &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;id:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">id</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">bbox_query_ids</span><span class="p">])</span>
            <span class="n">search_params</span><span class="p">[</span><span class="s">&#39;q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_q</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Definitely not in&quot;</span>

        <span class="k">return</span> <span class="n">search_params</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">after_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">search_results</span><span class="p">,</span> <span class="n">search_params</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">facet_json_data</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;global value is there...&quot;</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Facet json config is not available. Returning the default facets.&quot;</span>
            <span class="n">helpers</span><span class="o">.</span><span class="n">load_ngds_facets</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      <p>print "search_results: ",search_results</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="n">search_results</span>

    <span class="n">implements</span><span class="p">(</span><span class="n">IFacets</span><span class="p">,</span> <span class="n">inherit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">dataset_facets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">facets_dict</span><span class="p">,</span> <span class="n">package_type</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      <p>print "IFACETS is called.......&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;"</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">package_type</span> <span class="o">==</span> <span class="s">&#39;harvest&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="s">&#39;frequency&#39;</span><span class="p">,</span> <span class="s">&#39;Frequency&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;source_type&#39;</span><span class="p">,</span> <span class="s">&#39;Type&#39;</span><span class="p">)])</span>

        <span class="n">ngds_facets</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">load_ngds_facets</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ngds_facets</span><span class="p">:</span>
            <span class="n">facets_dict</span> <span class="o">=</span> <span class="n">ngds_facets</span>

        <span class="k">return</span> <span class="n">facets_dict</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">organization_facets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">facets_dict</span><span class="p">,</span> <span class="n">organization_type</span><span class="p">,</span> <span class="n">package_type</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      <p>print "IFACETS is called.......&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;"</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">package_type</span> <span class="o">==</span> <span class="s">&#39;harvest&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="s">&#39;frequency&#39;</span><span class="p">,</span> <span class="s">&#39;Frequency&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;source_type&#39;</span><span class="p">,</span> <span class="s">&#39;Type&#39;</span><span class="p">)])</span>

        <span class="n">ngds_facets</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">load_ngds_facets</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ngds_facets</span><span class="p">:</span>
            <span class="n">facets_dict</span> <span class="o">=</span> <span class="n">ngds_facets</span>

        <span class="k">return</span> <span class="n">facets_dict</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
